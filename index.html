<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MeteMatik</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f0f8ff, #e0f7fa);
      margin: 0;
      padding: 20px;
      text-align: center;
    }

    h1 {
      font-family: 'Fredoka', cursive;
      font-size: 3.2em;
      color: #333;
      margin-bottom: 10px;
    }

    #current-time {
      font-size: 2em;
      margin-top: -10px;
      margin-bottom: 20px;
      color: #333;
    }

    #glucose-section {
      font-size: 2em;
      font-weight: bold;
      margin: 10px 0;
    }

    .red { color: red; }
    .yellow { color: goldenrod; }
    .green { color: green; }

    #delta-time {
      font-size: 1em;
      color: #666;
      margin-bottom: 15px;
    }

    .carb-section {
      text-align: left;
      max-width: 400px;
      margin: 30px auto;
      padding: 20px;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .group-title {
      font-size: 1.3em;
      margin-top: 20px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 5px;
    }

    .carb-item {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
    }

    input[type="number"] {
      width: 80px;
      padding: 5px;
      font-size: 1em;
    }

    #idf {
      font-size: 1em;
      padding: 5px;
      width: 60px;
    }

    #carb-result {
      font-size: 2em;
      font-weight: bold;
      margin-top: 15px;
      color: #333;
    }

    .emoji {
      margin-right: 8px;
    }
  </style>
</head>
<body>

  <h1>MeteMatik</h1>
  <div id="current-time">--:--</div>

  <div id="glucose-section">≈ûeker: Veri alƒ±nƒ±yor...</div>
  <div id="delta-time">Zaman bilgisi y√ºkleniyor...</div>

  <label for="idf">IDF:</label>
  <input type="number" id="idf" value="75" min="50" max="120" />
  <div id="bolus-result">Bolus √∂nerisi: - √ºnite</div>

  <div class="carb-section">
    <div class="group-title">üçï Pizza Grubu</div>
    <div class="carb-item">Pide <span>0.4</span></div>
    <div class="carb-item">Pi≈üi <span>0.4</span></div>

    <div class="group-title">üç≠ ≈ûeker Grubu</div>
    <div class="carb-item">Pasta Pastaban <span>0.5</span></div>
    <div class="carb-item">Puding (1 kase) <span>15</span></div>
    <div class="carb-item">Ya≈ü Pasta <span>0.45</span></div>
    <div class="carb-item">Karpuz <span>0.08</span></div>

    <div class="group-title">üåÆ Taco Grubu</div>
    <div class="carb-item">Ekmek <span>0.6</span></div>
    <div class="carb-item">Mantƒ± <span>0.35</span></div>
    <div class="carb-item">Simit <span>0.45</span></div>

    <div style="margin-top:20px;">
      <label for="foodAmount">Miktar (gram/kase):</label>
      <input type="number" id="foodAmount" placeholder="gram"/>
      <label for="foodRatio">Karb. oranƒ±:</label>
      <input type="number" id="foodRatio" placeholder="0.6"/>
      <button onclick="calculateCarbs()">Hesapla</button>
      <div id="carb-result">0 Karb</div>
    </div>
  </div>

  <script>
    const NS_URL = "https://metesensor-d65c04745f2a.herokuapp.com/api/v1/entries.json?count=2";

    async function fetchGlucose() {
      try {
        const res = await fetch(NS_URL);
        const data = await res.json();
        const [latest, previous] = data;
        const glucose = Math.round(latest.sgv);
        const delta = Math.round(latest.sgv - previous.sgv);
        const date = new Date(latest.date);
        const now = new Date();
        const minutesAgo = Math.floor((now - date) / 60000);

        // renk se√ßimi
        let color = "green";
        if (glucose >= 250 || glucose < 70) color = "red";
        else if (glucose >= 180) color = "yellow";

        // trend oklarƒ±
        const trends = {
          DoubleUp: "‚Üë‚Üë", SingleUp: "‚Üë",
          FortyFiveUp: "‚Üó", Flat: "‚Üí",
          FortyFiveDown: "‚Üò", SingleDown: "‚Üì",
          DoubleDown: "‚Üì‚Üì"
        };
        const trendArrow = trends[latest.direction] || "?";

        document.getElementById("glucose-section").innerHTML =
          `<span class="${color}">${glucose} ${trendArrow} (${delta >= 0 ? "+" : ""}${delta})</span>`;

        // zaman bilgisi
        const saat = date.toLocaleTimeString("tr-TR", { hour: '2-digit', minute: '2-digit' });
        document.getElementById("delta-time").innerText =
          `${minutesAgo} dakika √∂nce (${saat})`;

        // bolus hesaplama
        const idf = parseFloat(document.getElementById("idf").value);
        const bolus = Math.max(0, ((glucose - 100) / idf)).toFixed(1);
        document.getElementById("bolus-result").innerText = `Bolus √∂nerisi: ${bolus} √ºnite`;

        // sekme ba≈ülƒ±ƒüƒ± g√ºncelle
        document.title = `${glucose} ${trendArrow} ${delta >= 0 ? "+" : ""}${delta}`;
      } catch (e) {
        document.getElementById("glucose-section").innerText = "≈ûeker: Veri alƒ±namadƒ±";
        document.getElementById("bolus-result").innerText = "Bolus √∂nerisi: - √ºnite";
        document.title = "MeteMatik";
      }
    }

    function calculateCarbs() {
      const gram = parseFloat(document.getElementById("foodAmount").value);
      const ratio = parseFloat(document.getElementById("foodRatio").value);
      if (!isNaN(gram) && !isNaN(ratio)) {
        const result = (gram * ratio).toFixed(1);
        document.getElementById("carb-result").innerText = `${result} Karb`;
      }
    }

    // Saat g√ºncelleme
    function updateClock() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString("tr-TR", { hour: '2-digit', minute: '2-digit' });
      document.getElementById("current-time").innerText = timeStr;
    }

    setInterval(fetchGlucose, 20000);
    setInterval(updateClock, 1000);
    fetchGlucose();
    updateClock();
  </script>
</body>
</html>
