<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MeteMatik</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to bottom, #f9f9f9, #e0f7fa);
      color: #333;
      text-align: center;
      padding: 1rem;
    }
    h1 {
      font-size: 3rem;
      font-weight: bold;
      color: #00796b;
      margin-bottom: 0.5rem;
    }
    #clock {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    .sugar {
      font-size: 2.5rem;
      margin-top: 1rem;
    }
    .yellow { color: orange; }
    .red { color: red; }
    .green { color: green; }

    .carb-group {
      display: inline-block;
      width: 30%;
      vertical-align: top;
      margin-top: 1rem;
    }
    .carb-group h3 {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }
    .carb-item {
      margin: 0.5rem;
    }
    input[type="number"] {
      width: 60px;
    }
    #carbTotal {
      font-size: 2rem;
      font-weight: bold;
      margin-top: 1rem;
    }
    .small {
      font-size: 0.9rem;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>MeteMatik</h1>
  <div id="clock"></div>

  <div id="sugarData" class="sugar">≈ûeker: -</div>
  <div id="bolus">Bolus √∂nerisi: -</div>
  <div id="timeInfo" class="small"></div>

  <div style="margin:1rem;">
    IDF: <input type="number" id="idf" value="75" min="50" max="120" />
  </div>

  <div>
    <div class="carb-group">
      <h3>üçï Pizza</h3>
      <div class="carb-item">Pide: <input type="number" data-carb="0.4" />g</div>
      <div class="carb-item">Pi≈üi: <input type="number" data-carb="0.4" />g</div>
    </div>

    <div class="carb-group">
      <h3>üç¨ ≈ûeker</h3>
      <div class="carb-item">Pasta pastaban: <input type="number" data-carb="0.5" />g</div>
      <div class="carb-item">Puding (1 kase): <input type="number" data-carb="15" />g</div>
      <div class="carb-item">Ya≈ü pasta: <input type="number" data-carb="0.45" />g</div>
      <div class="carb-item">Karpuz: <input type="number" data-carb="0.08" />g</div>
    </div>

    <div class="carb-group">
      <h3>üåÆ Taco</h3>
      <div class="carb-item">Ekmek: <input type="number" data-carb="0.6" />g</div>
      <div class="carb-item">Mantƒ±: <input type="number" data-carb="0.35" />g</div>
      <div class="carb-item">Simit: <input type="number" data-carb="0.45" />g</div>
    </div>
  </div>

  <div id="carbTotal">Toplam Karbonhidrat: 0g</div>

  <script>
    const apiUrl = "https://metesensor-d65c04745f2a.herokuapp.com/api/v1/entries.json?count=2";

    const trendArrows = {
      "DoubleUp": "‚Üë‚Üë",
      "SingleUp": "‚Üë",
      "FortyFiveUp": "‚Üó",
      "Flat": "‚Üí",
      "FortyFiveDown": "‚Üò",
      "SingleDown": "‚Üì",
      "DoubleDown": "‚Üì‚Üì"
    };

    function fetchData() {
      fetch(apiUrl)
        .then(res => res.json())
        .then(data => {
          if (!data || data.length < 1) throw new Error("Veri alƒ±namadƒ±");

          const [latest, previous] = data;
          const sugar = Math.round(latest.sgv);
          const previousSugar = previous ? previous.sgv : sugar;
          const delta = sugar - previousSugar;
          const trend = trendArrows[latest.direction] || "";
          const colorClass = sugar >= 250 || sugar < 70 ? 'red' : sugar >= 180 ? 'yellow' : 'green';

          const display = `${sugar} ${trend} (${delta >= 0 ? '+' : ''}${delta})`;
          document.title = display;

          document.getElementById("sugarData").innerHTML = `<span class="${colorClass}">${sugar} ${trend}</span>`;
          const idf = parseFloat(document.getElementById("idf").value || 75);
          const bolus = Math.round((delta > 0 ? (sugar - 120) / idf : 0) * 10) / 10;
          document.getElementById("bolus").innerText = `Bolus √∂nerisi: ${bolus > 0 ? bolus : 0} √ºnite`;

          const measureTime = new Date(latest.date);
          const now = new Date();
          const minsAgo = Math.floor((now - measureTime) / 60000);
          const h = measureTime.getHours().toString().padStart(2, "0");
          const m = measureTime.getMinutes().toString().padStart(2, "0");
          document.getElementById("timeInfo").innerText = `${minsAgo} dakika √∂nce ${h}:${m}`;
        })
        .catch(() => {
          document.getElementById("sugarData").innerText = "≈ûeker: Veri alƒ±namadƒ±";
          document.getElementById("bolus").innerText = "Bolus √∂nerisi: -";
        });
    }

    function updateClock() {
      const now = new Date();
      const h = now.getHours().toString().padStart(2, "0");
      const m = now.getMinutes().toString().padStart(2, "0");
      document.getElementById("clock").innerText = `${h}:${m}`;
    }

    function calculateCarbs() {
      const inputs = document.querySelectorAll('input[data-carb]');
      let total = 0;
      inputs.forEach(input => {
        const g = parseFloat(input.value || 0);
        const factor = parseFloat(input.dataset.carb);
        total += g * factor;
      });
      document.getElementById("carbTotal").innerText = `Toplam Karbonhidrat: ${Math.round(total)}g`;
    }

    document.querySelectorAll('input[data-carb]').forEach(input => {
      input.addEventListener('input', calculateCarbs);
    });

    document.getElementById("idf").addEventListener('input', fetchData);

    updateClock();
    fetchData();
    setInterval(updateClock, 30000);
    setInterval(fetchData, 30000);
  </script>
</body>
</html>
