<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MeteMatik</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f0f8ff, #e0f7fa);
      margin: 0;
      padding: 20px;
      text-align: center;
    }

    h1 {
      font-family: 'Fredoka', cursive;
      font-size: 3.5em;
      color: #333;
      margin-bottom: 0;
    }

    #current-time {
      font-size: 2em;
      margin-top: 5px;
      color: #333;
    }

    #glucose-section {
      font-size: 2.2em;
      font-weight: bold;
      margin: 20px 0 5px;
    }

    .red { color: red; }
    .yellow { color: goldenrod; }
    .green { color: green; }

    #delta-time {
      font-size: 1em;
      color: #666;
      margin-bottom: 20px;
    }

    label {
      font-weight: bold;
    }

    #idf {
      font-size: 1em;
      padding: 5px;
      width: 60px;
      margin-left: 5px;
    }

    #bolus-result {
      font-size: 1.2em;
      margin: 10px;
    }

    .carb-section {
      max-width: 1000px;
      margin: auto;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      text-align: left;
    }

    .group {
      flex: 1;
      padding: 10px;
      min-width: 280px;
    }

    .group-title {
      font-size: 1.3em;
      margin-bottom: 10px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 5px;
    }

    .carb-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
    }

    .carb-item input {
      width: 60px;
      padding: 5px;
      font-size: 1em;
      margin-left: 10px;
    }

    #carb-result {
      font-size: 2em;
      font-weight: bold;
      margin-top: 30px;
      color: #333;
    }

    input[type="number"] {
      font-size: 1em;
    }

  </style>
</head>
<body>

  <h1>MeteMatik</h1>
  <div id="current-time">--:--</div>

  <div id="glucose-section">≈ûeker: Veri alƒ±nƒ±yor...</div>
  <div id="delta-time">Zaman bilgisi y√ºkleniyor...</div>

  <label for="idf">IDF:</label>
  <input type="number" id="idf" value="75" min="50" max="120" />
  <div id="bolus-result">Bolus √∂nerisi: - √ºnite</div>

  <div class="carb-section">
    <div class="group">
      <div class="group-title">üçï Pizza Grubu</div>
      <div class="carb-item">Pide (0.4)<input type="number" data-ratio="0.4"/></div>
      <div class="carb-item">Pi≈üi (0.4)<input type="number" data-ratio="0.4"/></div>
    </div>

    <div class="group">
      <div class="group-title">üç≠ ≈ûeker Grubu</div>
      <div class="carb-item">Pasta Pastaban (0.5)<input type="number" data-ratio="0.5"/></div>
      <div class="carb-item">Puding 1 kase (15)<input type="number" data-ratio="15"/></div>
      <div class="carb-item">Ya≈ü Pasta (0.45)<input type="number" data-ratio="0.45"/></div>
      <div class="carb-item">Karpuz (0.08)<input type="number" data-ratio="0.08"/></div>
    </div>

    <div class="group">
      <div class="group-title">üåÆ Taco Grubu</div>
      <div class="carb-item">Ekmek (0.6)<input type="number" data-ratio="0.6"/></div>
      <div class="carb-item">Mantƒ± (0.35)<input type="number" data-ratio="0.35"/></div>
      <div class="carb-item">Simit (0.45)<input type="number" data-ratio="0.45"/></div>
    </div>
  </div>

  <div id="carb-result">0 Karb</div>

  <script>
    const NS_URL = "https://metesensor-d65c04745f2a.herokuapp.com/api/v1/entries.json?count=2";

    async function fetchGlucose() {
      try {
        const res = await fetch(NS_URL);
        const data = await res.json();
        if (!Array.isArray(data) || data.length < 2) throw new Error("Yetersiz veri");
        const [latest, previous] = data;
        const glucose = Math.round(latest.sgv);
        const delta = Math.round(latest.sgv - previous.sgv);
        const date = new Date(latest.date);
        const now = new Date();
        const minutesAgo = Math.floor((now - date) / 60000);

        let color = "green";
        if (glucose >= 250 || glucose < 70) color = "red";
        else if (glucose >= 180) color = "yellow";

        const trends = {
          DoubleUp: "‚Üë‚Üë", SingleUp: "‚Üë",
          FortyFiveUp: "‚Üó", Flat: "‚Üí",
          FortyFiveDown: "‚Üò", SingleDown: "‚Üì",
          DoubleDown: "‚Üì‚Üì"
        };
        const trendArrow = trends[latest.direction] || "?";

        document.getElementById("glucose-section").innerHTML =
          `<span class="${color}">${glucose} ${trendArrow} (${delta >= 0 ? "+" : ""}${delta})</span>`;

        const saat = date.toLocaleTimeString("tr-TR", { hour: '2-digit', minute: '2-digit' });
        document.getElementById("delta-time").innerText =
          `${minutesAgo} dakika √∂nce (${saat})`;

        const idf = parseFloat(document.getElementById("idf").value);
        const bolus = Math.max(0, ((glucose - 100) / idf)).toFixed(1);
        document.getElementById("bolus-result").innerText = `Bolus √∂nerisi: ${bolus} √ºnite`;

        document.title = `${glucose} ${trendArrow} (${delta >= 0 ? "+" : ""}${delta})`;

      } catch (e) {
        document.getElementById("glucose-section").innerText = "≈ûeker: Veri alƒ±namadƒ±";
        document.getElementById("bolus-result").innerText = "Bolus √∂nerisi: - √ºnite";
        document.title = "MeteMatik";
      }
    }

    function calculateCarbs() {
      const inputs = document.querySelectorAll('.carb-item input');
      let total = 0;
      inputs.forEach(input => {
        const gram = parseFloat(input.value);
        const ratio = parseFloat(input.dataset.ratio);
        if (!isNaN(gram)) {
          total += ratio * gram;
        }
      });
      document.getElementById("carb-result").innerText = `${total.toFixed(1)} Karb`;
    }

    function updateClock() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString("tr-TR", { hour: '2-digit', minute: '2-digit' });
      document.getElementById("current-time").innerText = timeStr;
    }

    document.querySelectorAll('.carb-item input').forEach(input => {
      input.addEventListener('input', calculateCarbs);
    });

    document.getElementById("idf").addEventListener('input', fetchGlucose);

    setInterval(fetchGlucose, 20000);
    setInterval(updateClock, 1000);
    fetchGlucose();
    updateClock();
  </script>
</body>
</html>
